<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aton4ST Demo</title>
    <link rel="stylesheet" href="css/demo.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header>
        <img src="img/aton4stlogo.jpg" alt="Aton4ST Logo" class="logo">
        <nav>
            <a href="index.html">Home</a>
            <a href="features.html">Features</a>
            <a href="demo.html">Demo</a>
            <a href="about.html">About</a>
            <a href="contact.html">Contact</a>
        </nav>
    </header>

    <div class="demo-container">
        <section id="demo-video">
            <h2>Aton4ST Platform Overview</h2>
            <div class="video-embed">
                <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" title="Aton4ST Demo Placeholder" frameborder="0"></iframe>
            </div>

            <h3>Climate Analysis Engine</h3>
            <div class="climate-analysis-trigger">
                <h3>Run Server-Side Analysis</h3>
                <button onclick="runClimateAnalysis()">Analyze Mock Dataset</button>
                <h4>Analysis Results:</h4>
                <pre id="analysis-results">Click button to run analysis...</pre>
            </div>
        </section>

        <div class="interactive-demo">
            <div class="climate-dashboard">
                <h3>Real-time Climate Metrics</h3>
                <div class="chart-container">
                    <canvas id="climateChart"></canvas>
                </div>
                <div class="climate-chatbot">
                    <h4>Climate Data Assistant</h4>
                    <div class="chat-history" id="climateChat">
                        <div class="message bot">Ask me about climate trends or Earth observation data!</div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="climateQuery" placeholder="Type your climate question..." 
                               onkeydown="if(event.key === 'Enter') sendClimateQuery()">
                        <button onclick="sendClimateQuery()">Ask</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="globe-scene" style="width: 100%; height: 500px;">
        <canvas id="climateGlobe"></canvas>
    </div>

    <footer>
        <p>© 2025 Aton4ST. Democratizing Space Science.</p>
        <a href="#">License</a> | <a href="#">Privacy</a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Fully Loaded - Initializing Scripts");
            const API_KEY = 'AIzaSyB-qg2CY7gGfowh5ITW5PwljgMMXlNKVHg'; // Consider moving to server-side

            // ---------- Climate Analysis ----------
            async function fetchClimateData(lat=40.71, lon=-74.01, startDate='2020-01-01', endDate='2023-01-01') {
                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_mean,precipitation_sum&timezone=auto`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error("Climate data fetch failed:", error);
                    return null;
                }
            }

            window.runClimateAnalysis = async function() {
                const resultsDisplay = document.getElementById('analysis-results');
                resultsDisplay.textContent = 'Analyzing...';

                try {
                    const climateData = await fetchClimateData();
                    if (!climateData) throw new Error("No climate data received");

                    const analysisData = climateData.daily.time.map((date, index) => ({
                        date,
                        temperature: climateData.daily.temperature_2m_mean[index],
                        precipitation: climateData.daily.precipitation_sum[index]
                    }));

                    resultsDisplay.textContent = JSON.stringify(analysisData, null, 2);
                } catch (error) {
                    resultsDisplay.textContent = `Error: ${error.message}`;
                }
            }

            // ---------- 3D Globe Implementation ----------
            function initializeGlobe() {
                const globeCanvas = document.getElementById('climateGlobe');
                const container = document.getElementById('globe-scene');
                
                if (!globeCanvas || !container) return;

                // Scene setup
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ 
                    canvas: globeCanvas,
                    antialias: true,
                    alpha: true
                });

                // Handle texture errors
                const handleTextureError = (error) => {
                    console.error('Texture loading error:', error);
                    material.map = new THREE.TextureLoader().load('img/fallback-texture.jpg');
                };

                // Globe material
                const textureLoader = new THREE.TextureLoader();
                const material = new THREE.MeshPhongMaterial({
                    map: textureLoader.load('img/earth-texture.jpg', undefined, handleTextureError),
                    specularMap: textureLoader.load('img/earth-specular.jpg', undefined, handleTextureError),
                    specular: new THREE.Color('grey')
                });

                // Create sphere
                const earth = new THREE.Mesh(
                    new THREE.SphereGeometry(4, 32, 32),
                    material
                );
                scene.add(earth);

                // Lighting
                scene.add(new THREE.AmbientLight(0xffffff, 0.6));
                const pointLight = new THREE.PointLight(0xffffff, 0.9);
                pointLight.position.set(15, 20, 15);
                scene.add(pointLight);

                // Animation
                camera.position.z = 10;
                function animate() {
                    requestAnimationFrame(animate);
                    earth.rotation.y += 0.003;
                    renderer.render(scene, camera);
                }
                animate();

                // Handle window resize
                window.addEventListener('resize', () => {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                });
            }
            initializeGlobe();

            // ---------- Climate Chart ----------
            async function initializeChart() {
                const ctx = document.getElementById('climateChart')?.getContext('2d');
                if (!ctx) return;

                try {
                    const data = await fetchClimateData();
                    if (!data) throw new Error('No chart data available');

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.daily.time.map(date => date.substring(0, 7)), // Show YYYY-MM
                            datasets: [{
                                label: 'Temperature (°C)',
                                data: data.daily.temperature_2m_mean,
                                borderColor: '#ff6b6b',
                                fill: true,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#333' } },
                                tooltip: { mode: 'index' }
                            },
                            scales: {
                                x: { ticks: { maxTicksLimit: 10 } }
                            }
                        }
                    });
                } catch (error) {
                    ctx.canvas.parentElement.innerHTML = `<p>Chart Error: ${error.message}</p>`;
                }
            }
            initializeChart();

            // ---------- Enhanced Chat System ----------
            window.sendClimateQuery = async function() {
                const input = document.getElementById('climateQuery');
                const chat = document.getElementById('climateChat');
                const message = input.value.trim();
                if (!message) return;

                // Disable input during processing
                input.disabled = true;
                
                // Add user message
                const userMsg = document.createElement('div');
                userMsg.className = 'message user';
                userMsg.textContent = message;
                chat.appendChild(userMsg);

                // Add thinking indicator
                const thinkingMsg = document.createElement('div');
                thinkingMsg.className = 'message bot typing';
                thinkingMsg.textContent = 'Analyzing...';
                chat.appendChild(thinkingMsg);
                chat.scrollTop = chat.scrollHeight;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `As a climate science expert, answer this question: ${message}. 
                                           Use verified data sources and maintain a professional tone.`
                                }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    const botResponse = data.candidates[0].content.parts[0].text;
                    
                    thinkingMsg.textContent = botResponse;
                    thinkingMsg.classList.remove('typing');
                } catch (error) {
                    thinkingMsg.textContent = `Error: ${error.message}`;
                    thinkingMsg.classList.remove('typing');
                    console.error("Chat error:", error);
                } finally {
                    input.disabled = false;
                    input.focus();
                    chat.scrollTop = chat.scrollHeight;
                }
            }
        });
    </script>
</body>
</html>