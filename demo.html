<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aton4ST Demo</title>
    <link rel="stylesheet" href="./css/demo.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <header>
        <img src="img/aton4stlogo.jpg" alt="Aton4ST Logo" class="logo">
        <nav>
            <a href="demo.html">Home</a>
            <a href="#">Features</a>
            <a href="demo.html">Demo</a>
            <a href="#">About</a>
            <a href="#">Contact</a>
        </nav>
    </header>

    <div class="demo-container">
        <section id="demo-video">
            <h2>Aton4ST Platform Overview</h2>
            <div class="video-embed">
                <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" title="Aton4ST Demo Placeholder" frameborder="0"></iframe>
            </div>

            <h3>Climate Analysis Engine</h3>
            <div class="climate-analysis-trigger">
                <h3>Run Server-Side Analysis</h3>
                <button onclick="runClimateAnalysis()">Analyze Mock Dataset</button>
                <h4>Analysis Results:</h4>
                <pre id="analysis-results">Click button to run analysis...</pre>
            </div>
        </section>

        <div class="interactive-demo">
            <div class="climate-dashboard">
                <h3>Real-time Climate Metrics</h3>
                <div class="chart-container">
                    <canvas id="climateChart"></canvas>
                </div>
                <div class="climate-chatbot">
                    <h4>Climate Data Assistant</h4>
                    <div class="chat-history" id="climateChat">
                        <div class="message bot">Ask me about climate trends or Earth observation data!</div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="climateQuery" placeholder="Type your climate question..." onkeydown="if(event.key === 'Enter') sendClimateQuery()">
                        <button onclick="sendClimateQuery()">Ask</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add 3D Globe Container -->
    <div id="globe-scene" style="width: 100%; height: 500px;">
        <canvas id="climateGlobe"></canvas>
    </div>

    <footer>
        <p>© 2025 Aton4ST. Democratizing Space Science.</p>
        <a href="#">License</a> | <a href="#">Privacy</a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Fully Loaded - Initializing Scripts");

            // ---------- Climate Analysis ----------
            async function fetchClimateData(lat=40.71, lon=-74.01, startDate='2020-01-01', endDate='2023-01-01') {
                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_mean,precipitation_sum&timezone=auto`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error("Climate data fetch failed:", error);
                    return null;
                }
            }

            window.runClimateAnalysis = async function() {
                const resultsDisplay = document.getElementById('analysis-results');
                resultsDisplay.textContent = 'Analyzing...';

                try {
                    const climateData = await fetchClimateData();
                    if (!climateData) throw new Error("No climate data received");

                    const analysisData = climateData.daily.time.map((date, index) => ({
                        date,
                        temperature: climateData.daily.temperature_2m_mean[index],
                        precipitation: climateData.daily.precipitation_sum[index]
                    }));

                    resultsDisplay.textContent = JSON.stringify(analysisData, null, 2);
                } catch (error) {
                    resultsDisplay.textContent = `Error: ${error.message}`;
                }
            }

            // ---------- 3D Globe Implementation ----------
            function initializeGlobe() {
                const globeCanvas = document.getElementById('climateGlobe');
                const container = document.getElementById('globe-scene');
                
                if (!globeCanvas || !container) return;

                // Scene setup
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ 
                    canvas: globeCanvas,
                    antialias: true,
                    alpha: true
                });

                // Globe material
                const textureLoader = new THREE.TextureLoader();
                const material = new THREE.MeshPhongMaterial({
                    map: textureLoader.load('img/earth-texture.jpg'),
                    specularMap: textureLoader.load('img/earth-specular.jpg'),
                    specular: new THREE.Color('grey')
                });

                // Create sphere
                const earth = new THREE.Mesh(
                    new THREE.SphereGeometry(4, 32, 32),
                    material
                );
                scene.add(earth);

                // Lighting
                scene.add(new THREE.AmbientLight(0xffffff, 0.6));
                const pointLight = new THREE.PointLight(0xffffff, 0.9);
                pointLight.position.set(15, 20, 15);
                scene.add(pointLight);

                // Animation
                camera.position.z = 10;
                function animate() {
                    requestAnimationFrame(animate);
                    earth.rotation.y += 0.003;
                    renderer.render(scene, camera);
                }
                animate();
            }
            initializeGlobe();

            // ---------- Climate Chart ----------
            async function initializeChart() {
                const ctx = document.getElementById('climateChart').getContext('2d');
                const data = await fetchClimateData();

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.daily.time,
                        datasets: [{
                            label: 'Temperature (°C)',
                            data: data.daily.temperature_2m_mean,
                            borderColor: '#ff6b6b',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#333' } },
                            tooltip: { mode: 'index' }
                        }
                    }
                });
            }
            initializeChart();

            
            // Chat System
        const API_KEY = 'AIzaSyB-qg2CY7gGfowh5ITW5PwljgMMXlNKVHg';
        let chatHistory = [];

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            input.value = '';

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a climate science assistant. Provide factual answers using latest climate data: ${message}`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                const botResponse = data.candidates[0].content.parts[0].text;
                addMessage(botResponse, 'bot');
            } catch (error) {
                addMessage("Error connecting to the chat service", 'bot');
            }
        }

        function addMessage(text, sender) {
            const history = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = `${sender === 'user' ? 'You: ' : 'Aton4ST: '}${text}`;
            history.appendChild(messageDiv);
            history.scrollTop = history.scrollHeight;
        }

    </script>
</body>
</html>